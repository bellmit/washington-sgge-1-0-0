<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="EmpresaMap">

	<!-- <cache type="org.mybatis.caches.ehcache.LoggingEhcache"/>
	<cache type="org.mybatis.caches.ehcache.EhcacheCache"/>  -->

  	<!-- Result maps describe the mapping between the columns returned
       from a query, and the class properties.  A result map isn't
       necessary if the columns (or aliases) match to the properties
       exactly. [id]           [int] NOT NULL,
	[nome]         [varchar](100) NULL,
	[regime]       [int] NULL,
	[create_date]  [int] NOT NULL DEFAULT (datediff(second,'1/1/1970',getutcdate())),
    [create_user]  [varchar](50) NULL,
    [modify_date]  [int] NOT NULL DEFAULT (datediff(second,'1/1/1970',getutcdate())),
    [modify_user]  [varchar](50) NULL,-->

  <resultMap id="empresaResult" type="Empresa" extends="EntidadeMap.EntidadeResult">
	<!--<collection property="socios" column="id" select="SocioMap.fetchSocioByEmpresaId"/>
	<collection property="planoList" column="id" select="PlanoMap.fetchPlanoByEmpresa"/>
	<collection property="filialList" column="id" select="FilialMap.fetchAllFilialByEntidade"/>
	<collection property="depositoList" column="id" select="DepositoMap.fetchAllDepositoByEntidade"/>
	  <collection property="contaCorrenteList" column="id" select="ContaCorrenteMap.fetchAllDepositoByEntidade"/>
	<collection property="tarefaList" column="id" select="TarefaMap.fetchAllDepositoByEntidade"/>-->
  </resultMap>

   <resultMap id="empresaTableResult" type="Empresa" extends="EntidadeMap.EntidadeResult">
    <result property="parceiroId" column="parceiroId"/>
    <result property="contabilidadeId" column="contabilidadeId"/>
    <result property="permissaoTypeEnumValue" column="permissaoTypeEnumValue"/>
	</resultMap>


  <!--
		SQL fragments allow "parts" of SQL to be re-used in other SQL statements.
	-->
  <sql id="allEmpresaColumns">
			e.nome

,e.razao
,e.processId
,e.entidadeId
,e.emprId
,e.entidadeEnumValue
,e.statusEmpresa
,e.dtAbertura
,e.responsavel
,e.planosServicos
,e.regime
,e.create_date
,e.create_user
,e.modify_date
,e.modify_user
,e.parceiroId
,e.contabilidadeId
,e.permissaoTypeEnumValue
,e.configuracao
  </sql>

  <sql id="allEmpresaValues">
  			<include refid="EntidadeMap.allEntidadeValues"/>
  			,#{parceiroId}
	,#{contabilidadeId}
	,#{permissaoTypeEnumValue}
  </sql>

  <select id="fetchEmpresaRowCount" parameterType="EmpresaInquiryRequest" resultType="Integer">
     SELECT COUNT(id) AS RECORD_COUNT
        FROM entidade
        where entidadeEnumValue = 1

  </select>

  <select id="fetchAllEmpresas" resultMap="empresaTableResult">
    SELECT e.id,
	<include refid="allEmpresaColumns" />
    FROM entidade e where e.entidadeEnumValue = 1 ORDER BY nome ASC
  </select>

  <select id="fetchEmpresaById" parameterType="FetchByIdRequest" resultMap="empresaResult">
    			   SELECT
					e.id,	<include refid="allEmpresaColumns" />
 				   FROM entidade e
					where e.id = #{fetchId}
  </select>

    <select id="fetchEmpresaByNota" parameterType="Integer" resultMap="empresaResult">
    			   SELECT
					e.id,	<include refid="allEmpresaColumns" />
 				   FROM entidade e
					where e.id = #{id}
  </select>

  <select id="fetchAllEmpresasByRequest" parameterType="EmpresaInquiryRequest" resultMap="empresaResult">
     SELECT e.id,
    						<include refid="allEmpresaColumns" />
    				FROM entidade e <if test="userId != null"> INNER JOIN  users on (users.emprId = e.id and users.username like #{userId})</if>
					where e.entidadeEnumValue = 1
					<if test="permissaoTypeEnumValue != null">
						<if test="permissaoTypeEnumValue != 1 and permissaoTypeEnumValue != 2 and permissaoTypeEnumValue != 3 "> and e.emprId = #{emprId}</if>
						<if test="permissaoTypeEnumValue != 1 and permissaoTypeEnumValue != 4 and permissaoTypeEnumValue != 3 "> and e.parceiroId = #{parceiroId}</if>
						<if test="permissaoTypeEnumValue != 1 and permissaoTypeEnumValue != 4 and permissaoTypeEnumValue != 2 "> and e.contabilidadeId = #{contabilidadeId}</if>
					</if>
					<if test="id != null"> AND e.id = #{id}</if>
					ORDER BY id ASC



  </select>

<delete id="deleteEmpresaById" parameterType="Empresa">
  DELETE FROM entidade WHERE id = #{id}
 </delete>

 <delete id="deleteAllEmpresas">
	DELETE FROM entidade
  </delete>

   <insert id="insertEmpresa" parameterType="Empresa" useGeneratedKeys="true" keyProperty="id">
     INSERT INTO entidade  (
 <if test="id != null"><if test="id > 0">id,</if></if>
nome
,razao
,processId
,entidadeId
,emprId
,entidadeEnumValue
,statusEmpresa
,dtAbertura
,responsavel
,planosServicos
,regime
,create_date
,create_user
,modify_date
,modify_user
,parceiroId
,contabilidadeId
,configuracao
,permissaoTypeEnumValue
     )
   VALUES (<if test="id != null"><if test="id > 0">#{id},</if></if><include refid="allEmpresaValues" /> )
 </insert>

 <update id="updateEmpresa" parameterType="Empresa">
   UPDATE entidade SET
<if test="nome!= null">nome = #{nome},</if>
<if test="parceiroId!= null">parceiroId = #{parceiroId},</if>
<if test="contabilidadeId!= null">contabilidadeId = #{contabilidadeId},</if>
<if test="permissaoTypeEnumValue!= null">permissaoTypeEnumValue = #{permissaoTypeEnumValue},</if>
<if test="entidadeId!= null">entidadeId = #{entidadeId},</if>
<if test="numFunc!= null">numFunc = #{numFunc},</if>
<if test="entidadeEnumValue!= null">entidadeEnumValue = #{entidadeEnumValue},</if>
<if test="regime!= null">regime = #{regime.id},</if>
<if test="parentId!= null"> parentId=#{parentId},</if>
<if test="tabelaEnumValue!= null"> tabelaEnumValue=#{tabelaEnumValue},</if>
<if test="emprId!= null"> emprId=#{emprId},</if>
<if test="processId!= null"> processId=#{processId},</if>
<if test="modifyDateUTC!= null"> modify_date=#{modifyDateUTC},</if>
<if test="modifyUser!= null"> modify_user=#{modifyUser}</if>
   WHERE
    id = #{id}
 </update>

</mapper>